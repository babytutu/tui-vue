const fs = require('fs')
const path = require('path')
const template = require('./utils').template
const glob = require('glob')

var OUTPUT_FILE = path.join(__dirname, '../src/route.js')
const INPUT_PATH = path.join(__dirname, '../src/pages/doc-mds')
var MD_PATH = '/pages/doc-mds'
var generateExports = template`
/* Automatic generated by './build/build-router.js' */

import Vue from 'vue'
import VueRouter from 'vue-router'
import demoRoutes from './demo/routes' // demo
import entry from './app.vue'

Vue.use(VueRouter)

const routes = [
  {
    path: '/',
    component: entry,
    children: [
      {
        path: '',
        name: '',
        component: () => import('./pages/index.md'),
      },
      ${'map'},
    ]
  },
  demoRoutes,
  {
    path: '*',
    redirect: '/',
  }
]

const router = new VueRouter({
  routes
})

const layers = document.getElementsByClassName('tui-mask-bg')

router.beforeEach((to, from, next) => {
  // 删除顽固节点
  Array.from(layers).forEach((vv) => {
    vv.parentNode.removeChild(vv)
  })
  document.title = to.name || document.title
  next()
})

export default router
`

// 读取文档模块
const componentsFiles = glob.sync('*.md', {
  cwd: INPUT_PATH
})

const map = []

componentsFiles.map(file => {
  const dirname = file.replace(/\//g, '')
  const moduleName = dirname.replace('.md', '')
  map.push(`{
        path: '${moduleName}',
        name: '${moduleName}',
        component: () => import('.${MD_PATH}/${dirname}'),
      }`)
    }
)

fs.writeFileSync(OUTPUT_FILE, generateExports({
  map: map.join(',\n      '),
  MD_PATH,
}))

console.log(`build complete component md entry, path:${OUTPUT_FILE}`)
